"use strict";(self.webpackChunknblocks_docs=self.webpackChunknblocks_docs||[]).push([[5920],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=a,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||o;return n?r.createElement(m,i(i({ref:t},p),{},{components:n})):r.createElement(m,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>i});var r=n(7294),a=n(6010);const o="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return r.createElement("div",{role:"tabpanel",className:(0,a.Z)(o,i),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>S});var r=n(7462),a=n(7294),o=n(6010),i=n(2466),s=n(6550),l=n(1980),c=n(7392),p=n(12);function u(e){return function(e){return a.Children.map(e,(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:a}}=e;return{value:t,label:n,attributes:r,default:a}}))}function d(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??u(n);return function(e){const t=(0,c.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function h(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const r=(0,s.k6)(),o=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(o),(0,a.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(r.location.search);t.set(o,e),r.replace({...r.location,search:t.toString()})}),[o,r])]}function v(e){const{defaultValue:t,queryString:n=!1,groupId:r}=e,o=d(e),[i,s]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!h({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:o}))),[l,c]=m({queryString:n,groupId:r}),[u,v]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,o]=(0,p.Nk)(n);return[r,(0,a.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:r}),g=(()=>{const e=l??u;return h({value:e,tabValues:o})?e:null})();(0,a.useLayoutEffect)((()=>{g&&s(g)}),[g]);return{selectedValue:i,selectValue:(0,a.useCallback)((e=>{if(!h({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);s(e),c(e),v(e)}),[c,v,o]),tabValues:o}}var g=n(2389);const k="tabList__CuJ",b="tabItem_LNqP";function f(e){let{className:t,block:n,selectedValue:s,selectValue:l,tabValues:c}=e;const p=[],{blockElementScrollPositionUntilNextRender:u}=(0,i.o5)(),d=e=>{const t=e.currentTarget,n=p.indexOf(t),r=c[n].value;r!==s&&(u(t),l(r))},h=e=>{let t=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const n=p.indexOf(e.currentTarget)+1;t=p[n]??p[0];break}case"ArrowLeft":{const n=p.indexOf(e.currentTarget)-1;t=p[n]??p[p.length-1];break}}t?.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":n},t)},c.map((e=>{let{value:t,label:n,attributes:i}=e;return a.createElement("li",(0,r.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>p.push(e),onKeyDown:h,onClick:d},i,{className:(0,o.Z)("tabs__item",b,i?.className,{"tabs__item--active":s===t})}),n??t)})))}function w(e){let{lazy:t,children:n,selectedValue:r}=e;const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===r));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},o.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function y(e){const t=v(e);return a.createElement("div",{className:(0,o.Z)("tabs-container",k)},a.createElement(f,(0,r.Z)({},e,t)),a.createElement(w,(0,r.Z)({},e,t)))}function S(e){const t=(0,g.Z)();return a.createElement(y,(0,r.Z)({key:String(t)},e))}},7112:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>c,default:()=>m,frontMatter:()=>l,metadata:()=>p,toc:()=>d});var r=n(7462),a=(n(7294),n(3905)),o=n(4866),i=n(5162),s=n(8669);const l={sidebar_position:4,sidebar_label:"Protect a backend (tutorial)",tags:["security","backend","tutorial"]},c="Protect your backend",p={unversionedId:"authentication-and-access/protect-backend",id:"authentication-and-access/protect-backend",title:"Protect your backend",description:"Securing your backend is even more important than securing your frontend since the backend usually holds sensitive and important information that we never want to return to a user that is either not logged in or not the rightful recipient of that information.",source:"@site/docs/02-authentication-and-access/protect-backend.mdx",sourceDirName:"02-authentication-and-access",slug:"/authentication-and-access/protect-backend",permalink:"/nblocks-docs/docs/authentication-and-access/protect-backend",draft:!1,tags:[{label:"security",permalink:"/nblocks-docs/docs/tags/security"},{label:"backend",permalink:"/nblocks-docs/docs/tags/backend"},{label:"tutorial",permalink:"/nblocks-docs/docs/tags/tutorial"}],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,sidebar_label:"Protect a backend (tutorial)",tags:["security","backend","tutorial"]},sidebar:"tutorialSidebar",previous:{title:"Protect a frontend (tutorial)",permalink:"/nblocks-docs/docs/authentication-and-access/protect-frontend"},next:{title:"User management portal (tutorial)",permalink:"/nblocks-docs/docs/authentication-and-access/user-management-portal"}},u={},d=[{value:"Short info about the access token",id:"short-info-about-the-access-token",level:2},{value:"How will the user provide the token to the backend on each request?",id:"how-will-the-user-provide-the-token-to-the-backend-on-each-request",level:3},{value:"Step 1. Protect an endpoint with role based access control",id:"step-1-protect-an-endpoint-with-role-based-access-control",level:2},{value:"Next steps",id:"next-steps",level:2}],h={toc:d};function m(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"protect-your-backend"},"Protect your backend"),(0,a.kt)("p",null,"Securing your backend is even more important than securing your frontend since the backend usually holds sensitive and important information that we never want to return to a user that is either not logged in or not the rightful recipient of that information."),(0,a.kt)("p",null,"In this guide we'll be showing you how easy it is to secure your application backend with Nblocks. You will apply protection by using the tokens obtained from the logged in user.\nBelow we will Protect an endpoint with role based access control, so that only users with the right privilege can query it."),(0,a.kt)("p",null,"After you're done with this guide you will have an application backend that is secure and ready for production."),(0,a.kt)("p",null,"The Nblocks team provides, maintains, and adds code examples for popular languages continuously.\nHowever, if you have a specific need not covered by this quickstart yet, you'll find documentation on how to use Nblocks with any language in our API reference ",(0,a.kt)("a",{parentName:"p",href:"https://nebulr-group.github.io/nblocks-api-docs"},"API reference"),"."),(0,a.kt)("admonition",{title:"Prerequisites",type:"info"},(0,a.kt)("ol",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ol"},"You have completed the ",(0,a.kt)("a",{parentName:"li",href:"/docs/getting-started/quickstart"},"Quickstart")," and have access to the tokens obtained from the logged in user."))),(0,a.kt)("h2",{id:"short-info-about-the-access-token"},"Short info about the access token"),(0,a.kt)("p",null,"When you completed the ",(0,a.kt)("a",{parentName:"p",href:"/docs/getting-started/quickstart"},"Quickstart")," you got hold of a couple of tokens that was signed securely by Nblocks.\nOne of them, the access token holds the users access information and this information can be used to protect your app.\nThe token is encoded in a format called ",(0,a.kt)("a",{parentName:"p",href:"https://jwt.io"},"JWT")," for greater portability and security. If we decode the access token it looks like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'\n{\n    "aid": "63d2ab029e23db0afb07a5a7",\n    "tid": "63d2b5c18892e10022e08399",\n    // highlight-start\n    "scope": "AUTHENTICATED USER_READ USER_WRITE TENANT_READ TENANT_WRITE",\n    "role": "OWNER",\n    // highlight-end\n    "plan": "FREE",\n    "iat": 1685648418,\n    "exp": 1685652018,\n    "aud": [\n        "63d2ab029e23db0afb07a5a7",\n        "https://app.nblocks.cloud"\n    ],\n    "iss": "https://auth.nblocks.cloud",\n    "sub": "63d2b5c18892e10022e083a2"\n}\n\n')),(0,a.kt)("admonition",{title:"Decoding and verifying JWTs",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"JWTs is a well known concept in security. That means there are plenty of libraries for many software stacks to decode and verify them into readable JSON. Here's a extensive ",(0,a.kt)("a",{parentName:"p",href:"https://jwt.io/libraries"},"list")," of different libraries.\nWe'll be using one of these in our code examples.")),(0,a.kt)("p",null,"In the structure above we highlighted the parts that we'll be focusing on in this guide. "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"role")," property tells the role of the user."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"scope")," property tells what privileges the user obtained when logging in as a that role. This can be used for more fine grained protection and role based access control on individual features."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"sub")," property shows the id of the user."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"tid")," property shows the id of the tenant")),(0,a.kt)("h3",{id:"how-will-the-user-provide-the-token-to-the-backend-on-each-request"},"How will the user provide the token to the backend on each request?"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If your developing an application with both a backend and a frontend it is best practise to let the frontend attach the access token as an ",(0,a.kt)("inlineCode",{parentName:"li"},"authorization")," header on each request to the backend."),(0,a.kt)("li",{parentName:"ul"},"When developing a backend only application you could either still resort to clients providing the ",(0,a.kt)("inlineCode",{parentName:"li"},"authorization")," header in each request or store the accessToken in a session cookie once you obtained it in the ",(0,a.kt)("a",{parentName:"li",href:"/docs/getting-started/quickstart"},"quickstart"),". Clients will provide this cookie automatically on every future request.")),(0,a.kt)("h2",{id:"step-1-protect-an-endpoint-with-role-based-access-control"},"Step 1. Protect an endpoint with role based access control"),(0,a.kt)(o.Z,{mdxType:"Tabs"},(0,a.kt)(i.Z,{value:"expressjs",label:"ExpressJS",default:!0,mdxType:"TabItem"},(0,a.kt)("p",null,"Imagine you have declared two endpoints, ",(0,a.kt)("inlineCode",{parentName:"p"},"/dashboardData")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"/analyticsData")," in your express app like this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const app = express();\n\napp.get('/dashboardData', (req, res) => {\n  ...\n});\n\napp.get('/analyticsData', (req, res) => {\n  ...\n});\n\napp.listen(port, () => {\n  console.log(`Example app listening at http://localhost:${port}`);\n});\n")),(0,a.kt)("p",null,"We want both of the endpoints to require the user to be logged in before rendering a result.\nThe ",(0,a.kt)("inlineCode",{parentName:"p"},"/analyticsData")," endpoint should only be accessable for users with the privilege ",(0,a.kt)("inlineCode",{parentName:"p"},"ANALYTICS_READ"),".\nAll this can easily be done with Express middlewares:"),(0,a.kt)("p",null,"Create a new file in which we declare two middlewares."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { jwtVerify, createRemoteJWKSet } from 'jose';\n\n// Verifies and decodes the access token from the authorization header\nconst jwtMiddleware = async (req, res, next) => {\n  if (req.headers['authorization']) {\n    try {\n      // Get the public key to verify the token signed by Nblocks\n      const JWKS = createRemoteJWKSet(\n        new URL('https://auth.nblocks.cloud/.well-known/jwks.json')\n      );\n\n      // Deconstruct user from the verified token and store the decoded information in a variable that can be used by other middlewares\n      const { payload: user } = await jwtVerify(\n        req.headers['authorization'], JWKS, { issuer: 'https://auth.nblocks.cloud' }\n      );\n      req.user = user;\n      next();\n    } catch (e) {\n      next(e);\n    }\n  }\n};\n\n// Grants or denies access based on the decoded token from jwtMiddleware\nconst protectedRoute = ({ roles, privileges }) => {\n  return (req, res, next) => {\n    if (req.user) {\n      if (\n        roles\n          ? roles.includes(req.user.role)\n          : false || privileges\n          ? privileges.some((scope) => req.user.scope.includes(scope))\n          : false\n      ) {\n        next();\n      } else {\n        res.status(403).send({ message: 'Forbidden' });\n      }\n    } else {\n      res.status(401).send({ message: 'Unauthorized' });\n    }\n  };\n};\n\nexport { jwtMiddleware, protectedRoute }\n")),(0,a.kt)("admonition",{title:"Handling users not logged in",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"If you're building a backend only app, you might want to redirect users to ",(0,a.kt)("inlineCode",{parentName:"p"},"/auth/login")," instead of rendering a ",(0,a.kt)("inlineCode",{parentName:"p"},"401 Unauthorized")," error in case they're unauthorized for a better user experience.")),(0,a.kt)("p",null,"Heading back to the initial express app file we can now make use of these middleware to start protecting the endpoints!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// highlight-start\nimport { jwtMiddleware, protectedRoute } from './middlewares'\n// highlight-end\n\nconst app = express();\n\n// highlight-start\n// First middleware that decodes tokens\napp.use(jwtMiddleware);\n\n// Restrict all endpoints globally with protectedRoute to require authenticated users\napp.use(protectedRoute({privileges: ['AUTHENTICATED']}));\n// highlight-end\n\napp.get('/dashboardData', (req, res) => {\n  ...\n});\n\n// highlight-start\n// Restrict /analyticsData with protectedRoute to require users with ANALYTICS_READ privilege\napp.get('/analyticsData', protectedRoute({privileges: ['ANALYTICS_READ']}), (req, res) => {\n// highlight-end\n  ...\n});\n\napp.listen(port, () => {\n  console.log(`Example app listening at http://localhost:${port}`);\n});\n")),(0,a.kt)("details",null,(0,a.kt)("summary",null,"More examples"),(0,a.kt)("p",null,"Our ",(0,a.kt)("inlineCode",{parentName:"p"},"protectedRoute")," middleware can be activated in other ways, like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// Protect all endpoints\napp.use(protectedRoute({privileges: ['AUTHENTICATED']}));\n\n// Protect /analyticsData\napp.use(\"/analyticsData\", protectedRoute({privileges: ['AUTHENTICATED']}));\n\n// Protect using wildcards\napp.use(\"/secret/*\", protectedRoute({roles: ['ADMIN']}));\n\n")))),(0,a.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,a.kt)("p",null,"Imagine you have declared two endpoints, ",(0,a.kt)("inlineCode",{parentName:"p"},"/protected/dashboardData")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"/protected/analyticsData")," in your Java app like this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'package com.mycompany.app;\n\nimport java.util.EnumSet;\nimport java.util.List;\n\nimport javax.servlet.DispatcherType;\n\nimport org.eclipse.jetty.server.Server;\nimport org.eclipse.jetty.servlet.FilterHolder;\nimport org.eclipse.jetty.servlet.ServletContextHandler;\nimport org.eclipse.jetty.servlet.ServletHolder;\n\npublic class App {\n    public static void main(String[] args) throws Exception {\n        Server server = new Server(8080);\n\n        ServletContextHandler context = new ServletContextHandler(ServletContextHandler.SESSIONS);\n        context.setContextPath("/");\n        server.setHandler(context);\n\n        context.addServlet(new ServletHolder(new LoginServlet()), "/login");\n        context.addServlet(new ServletHolder(new CallbackServlet()), "/auth/oauth-callback");\n        // highlight-start\n        context.addServlet(new ServletHolder(new DashboardDataServlet()), "/protected/dashboardData");\n        context.addServlet(new ServletHolder(new AnalyticsDataServlet()), "/protected/analyticsData");\n        // highlight-end\n\n        server.start();\n        server.join();\n    }\n}\n')),(0,a.kt)("p",null,"We want both of the endpoints to require the user to be logged in before rendering a result.\nThe ",(0,a.kt)("inlineCode",{parentName:"p"},"/analyticsData")," endpoint should only be accessable for users with the privilege ",(0,a.kt)("inlineCode",{parentName:"p"},"ANALYTICS_READ"),".\nAll this can easily be done with two Java servlet filters:"),(0,a.kt)("p",null,"Create a new Filter class, ",(0,a.kt)("inlineCode",{parentName:"p"},"JwtFilter"),", in which we declare the verification of JWTs:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'package com.mycompany.app;\n\nimport org.jose4j.jwa.AlgorithmConstraints;\nimport org.jose4j.jwa.AlgorithmConstraints.ConstraintType;\nimport org.jose4j.jwk.HttpsJwks;\nimport org.jose4j.jws.AlgorithmIdentifiers;\nimport org.jose4j.jwt.JwtClaims;\nimport org.jose4j.jwt.consumer.InvalidJwtException;\nimport org.jose4j.jwt.consumer.JwtConsumer;\nimport org.jose4j.jwt.consumer.JwtConsumerBuilder;\nimport org.jose4j.keys.resolvers.HttpsJwksVerificationKeyResolver;\n\nimport java.io.IOException;\n\nimport javax.servlet.Filter;\nimport javax.servlet.FilterChain;\nimport javax.servlet.FilterConfig;\nimport javax.servlet.ServletException;\nimport javax.servlet.ServletRequest;\nimport javax.servlet.ServletResponse;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\npublic class JwtFilter implements Filter {\n\n    // Replace this with your own APP ID\n    // highlight-start\n    private static final String APP_ID = "XXX";\n    // highlight-end\n\n    public static JwtClaims verifyJwt(String token) throws InvalidJwtException {\n        String JWKS_URL = "https://auth.nblocks.cloud/.well-known/jwks.json";\n\n        try {\n            // Verify the tokens result using public keys from Nblocks JWKS\n            HttpsJwks httpsJkws = new HttpsJwks(JWKS_URL);\n            HttpsJwksVerificationKeyResolver httpsJwksKeyResolver = new HttpsJwksVerificationKeyResolver(httpsJkws);\n\n            JwtConsumer jwtConsumer = new JwtConsumerBuilder()\n                    .setVerificationKeyResolver(httpsJwksKeyResolver)\n                    .setExpectedIssuer("https://auth.nblocks.cloud")\n                    .setExpectedAudience(APP_ID)\n                    .setJwsAlgorithmConstraints(new AlgorithmConstraints(ConstraintType.PERMIT,\n                            AlgorithmIdentifiers.RSA_PSS_USING_SHA256)) \n                    .build();\n\n            JwtClaims jwtClaims = jwtConsumer.processToClaims(token);\n            return jwtClaims;\n        } catch (InvalidJwtException e) {\n            e.printStackTrace();\n            return null;\n        }\n    }\n\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n            throws IOException, ServletException {\n\n        HttpServletRequest httpRequest = (HttpServletRequest) request;\n        String authHeader = httpRequest.getHeader("Authorization");\n        // Only run verficiation if Authorization header is present\n        if (authHeader != null && authHeader.startsWith("Bearer ")) {\n            String token = authHeader.substring("Bearer ".length());\n            try {\n                JwtClaims jwtClaims = verifyJwt(token);\n                httpRequest.setAttribute("user", jwtClaims.getClaimsMap());\n            } catch (Exception e) {\n                ((HttpServletResponse) response).sendError(HttpServletResponse.SC_UNAUTHORIZED, "Invalid token");\n                return;\n            }\n        }\n        chain.doFilter(request, response);\n    }\n\n    @Override\n    public void init(FilterConfig filterConfig) throws ServletException {\n        // Initialization logic here\n    }\n\n    @Override\n    public void destroy() {\n        // Cleanup logic here\n    }\n}\n')),(0,a.kt)("p",null,"And create another Filter class, ",(0,a.kt)("inlineCode",{parentName:"p"},"AccessControlFilter"),", in which we check the scopes of the requesting user:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'package com.mycompany.app;\n\nimport java.io.IOException;\nimport java.util.List;\nimport java.util.Map;\n\nimport javax.servlet.Filter;\nimport javax.servlet.FilterChain;\nimport javax.servlet.FilterConfig;\nimport javax.servlet.ServletException;\nimport javax.servlet.ServletRequest;\nimport javax.servlet.ServletResponse;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\npublic class AccessControlFilter implements Filter {\n    private List<String> roles;\n    private List<String> privileges;\n\n    public AccessControlFilter(List<String> roles, List<String> privileges) {\n        this.roles = roles;\n        this.privileges = privileges;\n    }\n\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n            throws IOException, ServletException {\n        HttpServletRequest httpRequest = (HttpServletRequest) request;\n        HttpServletResponse httpResponse = (HttpServletResponse) response;\n        Map<String, Object> user = (Map<String, Object>) httpRequest.getAttribute("user");\n        if (user != null) {\n            String role = (String) user.get("role");\n            String scope = (String) user.get("scope");\n            List<String> scopeList = List.of(scope.split(" "));\n            boolean roleCheck = roles != null ? roles.contains(role) : false;\n            boolean privilegeCheck = privileges != null ? scopeList.stream().anyMatch(privileges::contains) : false;\n            if (roleCheck || privilegeCheck) {\n                chain.doFilter(request, response);\n            } else {\n                httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN, "Forbidden");\n            }\n        } else {\n            httpResponse.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Unauthorized");\n        }\n    }\n\n    @Override\n    public void init(FilterConfig filterConfig) throws ServletException {\n        // Initialization logic here\n    }\n\n    @Override\n    public void destroy() {\n        // Cleanup logic here\n    }\n}\n')),(0,a.kt)("admonition",{title:"Handling users not logged in",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"If you're building a backend only app, you might want to redirect users to ",(0,a.kt)("inlineCode",{parentName:"p"},"/auth/login")," instead of rendering a ",(0,a.kt)("inlineCode",{parentName:"p"},"401 Unauthorized")," error in case they're unauthorized for a better user experience.")),(0,a.kt)("p",null,"Heading back to the initial Java app file, we can now make use of these filters to start protecting the endpoints!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'package com.mycompany.app;\n\nimport java.util.EnumSet;\nimport java.util.List;\n\nimport javax.servlet.DispatcherType;\n\nimport org.eclipse.jetty.server.Server;\nimport org.eclipse.jetty.servlet.FilterHolder;\nimport org.eclipse.jetty.servlet.ServletContextHandler;\nimport org.eclipse.jetty.servlet.ServletHolder;\n\npublic class App {\n    public static void main(String[] args) throws Exception {\n        Server server = new Server(8080);\n\n        ServletContextHandler context = new ServletContextHandler(ServletContextHandler.SESSIONS);\n        context.setContextPath("/");\n        server.setHandler(context);\n\n        context.addServlet(new ServletHolder(new LoginServlet()), "/login");\n        context.addServlet(new ServletHolder(new CallbackServlet()), "/auth/oauth-callback");\n        context.addServlet(new ServletHolder(new DashboardDataServlet()), "/protected/dashboardData");\n        context.addServlet(new ServletHolder(new AnalyticsDataServlet()), "/protected/analyticsData");\n        \n        //highlight-start\n        // Process all incoming requests with JwtFilter process and verify the JWT\n        context.addFilter(new FilterHolder(new JwtFilter()), "/*", EnumSet.of(DispatcherType.REQUEST));\n\n        // Restrict all protected endpoints globally with AccessControlFilter to require authenticated users\n        context.addFilter(new FilterHolder(new AccessControlFilter(null, List.of("AUTHENTICATED"))),\n                "/protected/*", EnumSet.of(DispatcherType.REQUEST));\n\n        // Restrict /analyticsData with AccessControlFilter to require users with ANALYTICS_READ privilege\n        context.addFilter(new FilterHolder(new AccessControlFilter(null, List.of("ANALYTICS_READ"))),\n                "/protected/analyticsData/*", EnumSet.of(DispatcherType.REQUEST));\n        //highlight-end\n\n        server.start();\n        server.join();\n    }\n}\n')),(0,a.kt)("details",null,(0,a.kt)("summary",null,"More examples"),(0,a.kt)("p",null,"Our ",(0,a.kt)("inlineCode",{parentName:"p"},"AccessControlFilter")," filter can be activated in other ways, like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'// Protect all endpoints with AUTHENTICATED privilege\ncontext.addFilter(new FilterHolder(new AccessControlFilter(null, List.of("AUTHENTICATED"))),\n        "/*", EnumSet.of(DispatcherType.REQUEST));\n\n// Protect /protected/analyticsData with AUTHENTICATED privilege\ncontext.addFilter(new FilterHolder(new AccessControlFilter(null, List.of("AUTHENTICATED"))),\n        "/protected/analyticsData/", EnumSet.of(DispatcherType.REQUEST));\n\n// Protect using wildcards with ADMIN role\ncontext.addFilter(new FilterHolder(new AccessControlFilter(List.of("ADMIN"), null)),\n        "/secret/*", EnumSet.of(DispatcherType.REQUEST));\n')))),(0,a.kt)(i.Z,{value:"pseudo",label:"Can't find your stack?",mdxType:"TabItem"},(0,a.kt)(s.ZP,{mdxType:"PseudoCode"}))),(0,a.kt)("h2",{id:"next-steps"},"Next steps"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Protect your frontend with user tokens."),(0,a.kt)("li",{parentName:"ul"},"Add Nblocks hosted user management to your app."),(0,a.kt)("li",{parentName:"ul"},"Add SSO alternatives to your login experience.")),(0,a.kt)("p",null,"If you haven't already, join our ",(0,a.kt)("a",{parentName:"p",href:"https://discord.gg/kjWYdZ6f6G"},"Discord")))}m.isMDXComponent=!0},8669:(e,t,n)=>{n.d(t,{ZP:()=>i});var r=n(7462),a=(n(7294),n(3905));const o={toc:[]};function i(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},o,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\nIf you cannot find your stack in the example code you need to integrate this part manually.\n\nNblocks can be integrated with any stack or framework. \nEssentially it's all about REST API calls or redirecting the user browser agent which is documented in more details in the API reference https://nebulr-group.github.io/nblocks-api-docs.\n\nUse the other code examples to understand what should to be done and in what order.\n\nWe'd be happy to get feedback so we can add more code examples so don't forget to make a request, by joining our Discord https://discord.gg/kjWYdZ6f6G and spell it out.\n\n")))}i.isMDXComponent=!0}}]);